results = {'head': {'vars': ['Title', 'starttimeValue', 'starttimePrecision', 'TitleLabel', 'endtimeValue', 'endtimePrecision']}, 'results': {'bindings': [{'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q27494237'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Chairman of the Council of CIS Heads of State'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2003-01-29T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2000-01-25T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q27494237'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Chairman of the Council of CIS Heads of State'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2017-12-31T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2017-01-01T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q38715304'}, 'TitleLabel': {'type': 'literal', 'value': 'Q38715304'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-08-09T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-03-29T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q842386'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Prime Minister of Russia'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2012-05-07T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2008-05-08T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q842386'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Prime Minister of Russia'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2000-05-07T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-08-16T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q140686'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'chairperson'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1997-01-01T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '9'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1995-01-01T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '9'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q27494237'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Chairman of the Council of CIS Heads of State'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2006-05-20T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2004-09-16T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q4399975'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Director of the Federal Security Service'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-03-29T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1998-07-25T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q4109060'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Supreme Commander-in-Chief of the Armed Forces of the Russian Federation'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2008-05-07T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-12-31T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q4127082'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'Acting President of Russia'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2000-05-07T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '1999-12-31T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}, {'Title': {'type': 'uri', 'value': 'http://www.wikidata.org/entity/Q218295'}, 'TitleLabel': {'xml:lang': 'en', 'type': 'literal', 'value': 'President of Russia'}, 'endtimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2008-05-07T00:00:00Z'}, 'endtimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}, 'starttimeValue': {'datatype': 'http://www.w3.org/2001/XMLSchema#dateTime', 'type': 'literal', 'value': '2000-05-07T00:00:00Z'}, 'starttimePrecision': {'datatype': 'http://www.w3.org/2001/XMLSchema#integer', 'type': 'literal', 'value': '11'}}]}}
import re
import re
import datefinder
from bs4 import BeautifulSoup
import requests as req
from SPARQLWrapper import SPARQLWrapper, JSON
from fake_useragent import UserAgent


def get_wiki_url(wikidata_id, lang='en', debug=False):
    import requests
    from requests import utils

    url = (
        'https://www.wikidata.org/w/api.php'
        '?action=wbgetentities'
        '&props=sitelinks/urls'
        f'&ids={wikidata_id}'
        '&format=json')
    json_response = requests.get(url).json()
    if debug: print(wikidata_id, url, json_response)

    entities = json_response.get('entities')
    if entities:
        entity = entities.get(wikidata_id)
        if entity:
            sitelinks = entity.get('sitelinks')
            if sitelinks:
                if lang:
                    # filter only the specified language
                    sitelink = sitelinks.get(f'{lang}wiki')
                    if sitelink:
                        wiki_url = sitelink.get('url')
                        if wiki_url:
                            return requests.utils.unquote(wiki_url)
                else:
                    # return all of the urls
                    wiki_urls = {}
                    for key, sitelink in sitelinks.items():
                        wiki_url = sitelink.get('url')
                        if wiki_url:
                            wiki_urls[key] = requests.utils.unquote(wiki_url)
                    return wiki_urls
    return None


def page_open_body(name):
    resp = req.get(name)
    soup = BeautifulSoup(resp.text, 'lxml')
    main_part = str(soup.body)
    return main_part


# ФУНКЦИЯ ПОЛУЧЕНИЯ ДАТЫ НАЧАЛО
# ФУНКЦИЯ ПОЛУЧЕНИЯ ДАТЫ НАЧАЛО
def get_dates_from_url(url, name, title):
    try:
        def get_dates(page, pattern):
            new = re.findall(pattern, str(page))

            date = ''
            date_list = []
            state = False
            for j in new:
                for i in j:
                    if i == '<':
                        state = True
                    if i == '>':
                        state = False
                    if i == '<':
                        state = True
                    if i == '>':
                        state = False
                    if i == '[':
                        state = True
                    if i == ']':
                        state = False
                    if i == '(':
                        state = True
                    if i == ')':
                        state = False

                    if not state:
                        if i != ']' and i != '>' and i != ')':
                            date += i
                date_list.append(date)
                date = ''

            data_list_new = []

            for i in date_list:
                new_elem = i.replace(u'\xa0', u' ')
                data_list_new.append(new_elem)

            return data_list_new

        sparql = SPARQLWrapper("http://query.wikidata.org/sparql", agent=UserAgent().random)
        sparql.setQuery("""SELECT ?Title ?starttimeValue ?TitleLabel ?starttimePrecision ?endtimeValue ?endtimePrecision  WHERE {
    wd:%s p:P39 ?TitleStatementNode.
    ?TitleStatementNode ps:P39 ?Title.
    ?TitleStatementNode pqv:P580 ?starttimenode.
    ?TitleStatementNode pqv:P582 ?endtimenode.
    ?starttimenode wikibase:timeValue         ?starttimeValue.
    ?starttimenode wikibase:timePrecision     ?starttimePrecision.
    ?endtimenode wikibase:timeValue         ?endtimeValue.
    ?endtimenode wikibase:timePrecision     ?endtimePrecision.
    SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }


    }""" % name)
        sparql.setReturnFormat(JSON)
        results = sparql.query().convert()

        title_dict = {}
        counter_dict = {}
        for i in range(0, len(results['results']['bindings'])):
            state_repeat = False

            Title_ID = results['results']['bindings'][i]['TitleLabel']['value']
            Title_ID = re.split('/', Title_ID)[-1]
            if Title_ID == title:
                if Title_ID in title_dict:
                    state_repeat = True
                    counter_dict[Title_ID] = counter_dict[Title_ID] + 1
                    title_dict[Title_ID].append([-1, -1, -1, -1])
                else:
                    counter_dict[Title_ID] = 1
                    title_dict[Title_ID] = []
                    title_dict[Title_ID].append([-1, -1, -1, -1])
                if state_repeat:
                    number = counter_dict[Title_ID] - 1

                    start_pos = results['results']['bindings'][i]['starttimeValue']['value']
                    start_pos = re.split('T', start_pos)[0]

                    BC_state = False
                    if start_pos[0] == '-':
                        BC_state = True
                        start_pos[1:]

                    state_to_write = False
                    new_word = ''
                    for char in start_pos:
                        if char != '0':
                            state_to_write = True
                        if state_to_write:
                            new_word += char
                    start_pos = new_word

                    start_pos = start_pos.replace('-', '.')
                    start_pos = list(reversed(start_pos.split('.')))
                    start_pos = '.'.join(start_pos)

                    if BC_state:
                        title_dict[Title_ID][number][0] = '-' + start_pos
                    else:
                        title_dict[Title_ID][number][0] = start_pos

                    start_accuracy = results['results']['bindings'][i]['starttimePrecision']['value']
                    title_dict[Title_ID][number][1] = str(11 - int(start_accuracy))

                    end_pos = results['results']['bindings'][i]['endtimeValue']['value']
                    end_pos = re.split('T', end_pos)[0]

                    if end_pos[0] == '-':
                        BC_state = True
                        end_pos = end_pos[1:]

                    state_to_write = False
                    new_word = ''
                    for char in end_pos:
                        if char != '0':
                            state_to_write = True
                        if state_to_write:
                            new_word += char
                    end_pos = new_word

                    end_pos = end_pos.replace('-', '.')
                    end_pos = list(reversed(end_pos.split('.')))
                    end_pos = '.'.join(end_pos)

                    if BC_state:
                        title_dict[Title_ID][number][2] = '-' + end_pos
                    else:
                        title_dict[Title_ID][number][2] = end_pos

                    end_accuracy = results['results']['bindings'][i]['endtimePrecision']['value']
                    title_dict[Title_ID][number][3] = str(11 - int(end_accuracy))
                else:
                    start_pos = results['results']['bindings'][i]['starttimeValue']['value']
                    start_pos = re.split('T', start_pos)[0]

                    BC_state = False
                    if start_pos[0] == '-':
                        BC_state = True
                        start_pos = start_pos[1:]

                    state_to_write = False
                    new_word = ''
                    for char in start_pos:
                        if char != '0':
                            state_to_write = True
                        if state_to_write:
                            new_word += char
                    start_pos = new_word

                    start_pos = start_pos.replace('-', '.')
                    start_pos = list(reversed(start_pos.split('.')))
                    start_pos = '.'.join(start_pos)
                    if BC_state:
                        title_dict[Title_ID][0][0] = '-' + start_pos
                    else:
                        title_dict[Title_ID][0][0] = start_pos

                    start_accuracy = results['results']['bindings'][i]['starttimePrecision']['value']
                    title_dict[Title_ID][0][1] = str(11 - int(start_accuracy))

                    end_pos = results['results']['bindings'][i]['endtimeValue']['value']
                    end_pos = re.split('T', end_pos)[0]

                    if end_pos[0] == '-':
                        BC_state = True
                        end_pos = end_pos[1:]

                    state_to_write = False
                    new_word = ''
                    for char in end_pos:
                        if char != '0':
                            state_to_write = True
                        if state_to_write:
                            new_word += char
                    end_pos = new_word

                    end_pos = end_pos.replace('-', '.')
                    end_pos = list(reversed(end_pos.split('.')))
                    end_pos = '.'.join(end_pos)

                    if BC_state:
                        title_dict[Title_ID][0][2] = '-' + end_pos
                    else:
                        title_dict[Title_ID][0][2] = end_pos

                    end_accuracy = results['results']['bindings'][i]['endtimePrecision']['value']
                    title_dict[Title_ID][0][3] = str(11 - int(end_accuracy))



        # ПОЛУЧЕНИЕ ЗАПРОСА ДОЛЖНОСТЕЙ КОТОРЫЕ СЕЙЧАС ПРАВЯТ

        sparql = SPARQLWrapper("http://query.wikidata.org/sparql", agent=UserAgent().random)
        sparql.setQuery("""SELECT ?Title ?starttimeValue ?starttimePrecision ?TitleLabel ?endtimeValue ?endtimePrecision  WHERE {
          wd:%s p:P39 ?TitleStatementNode.
          ?TitleStatementNode ps:P39 ?Title.
          ?TitleStatementNode pqv:P580 ?starttimenode.
          ?starttimenode wikibase:timeValue         ?starttimeValue.
          ?starttimenode wikibase:timePrecision     ?starttimePrecision.
          SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }


        }""" % name)
        sparql.setReturnFormat(JSON)
        results = sparql.query().convert()

        first_got = False
        for i in range(0, len(results['results']['bindings'])):
            if first_got:
                break
            Title_ID = results['results']['bindings'][i]['TitleLabel']['value']
            Title_ID = re.split('/', Title_ID)[-1]
            start_pos = results['results']['bindings'][i]['starttimeValue']['value']
            start_pos = re.split('T', start_pos)[0]

            BC_state = False
            if start_pos[0] == '-':
                BC_state = True
                start_pos = start_pos[1:]
            state_to_write = False
            new_word = ''
            for char in start_pos:
                if char != '0':
                    state_to_write = True
                if state_to_write:
                    new_word += char
            start_pos = new_word

            start_pos = start_pos.replace('-', '.')
            start_pos = list(reversed(start_pos.split('.')))
            start_pos = '.'.join(start_pos)


            # ПЕРЕДЕЛАТЬ НАДО!!!!!!
            if Title_ID in title_dict and not BC_state:
                for j in range(0, len(title_dict[Title_ID])):

                    if start_pos != title_dict[Title_ID][j][0]:

                        title_dict[Title_ID].append([-1, -1, -1, -1])
                        if BC_state:
                            title_dict[Title_ID][-1][0] = '-' + start_pos
                        else:
                            title_dict[Title_ID][-1][0] = start_pos
                        start_accuracy = results['results']['bindings'][i]['starttimePrecision']['value']
                        title_dict[Title_ID][-1][1] = str(11 - int(start_accuracy))
                        title_dict[Title_ID][-1][2] = 'по наст. время'
                        title_dict[Title_ID][-1][3] = '0'
                        first_got = True
                        break
            # ПЕРЕДЕЛАТЬ НАДО!!!!!!


        if title_dict != {}:
            new_data = title_dict[title]
        if title_dict == {}:

            changer = page_open_body(url)

            soup = BeautifulSoup(changer)
            page = soup.find('table', {'class': 'infobox vcard'})

            data_pattern = re.compile(r'%s</a>.*?office(.*?)</tr><tr>' % title)
            data_list = get_dates(page, data_pattern)

            if not data_list:
                data_pattern = re.compile(r'%s</a>.*?eign(.*?)</tr><tr>' % title)
                data_list = get_dates(page, data_pattern)
                if not data_list:
                    data_pattern = re.compile(r'eign(.*?)</tr><tr>')
                    data_list = get_dates(page, data_pattern)
            is_BC = False
            temp_str = data_list[0]

            pattern = re.compile(r'BC')
            match = re.findall(pattern, temp_str)
            if match:
                temp_str = temp_str.replace('BC', '')
                is_BC = True
            pattern = re.compile(r'BCE')
            match = re.findall(pattern, temp_str)
            if match:
                temp_str = temp_str.replace('BCE', '')
                is_BC = True
            pattern = re.compile(r'AC')
            match = re.findall(pattern, temp_str)
            if match:
                temp_str = temp_str.replace('AC', '')
                is_BC = True
            pattern = re.compile(r'AD')
            match = re.findall(pattern, temp_str)
            if match:
                temp_str = temp_str.replace('AD', '')
            if is_BC:
                pattern = re.compile(r'c\.')
                match = re.findall(pattern, temp_str)
                if match:
                    temp_str = temp_str.replace('c.', '')



            temp_str = re.sub(r"[#%!@*,.;]", "", temp_str)
            pattern = re.compile(r'–')  # РАЗНЫЕ СИМВОЛЫ, НЕ ТРОГАТЬ!!!!!
            match = re.findall(pattern, temp_str)
            if match:
                data_list = re.split(pattern, temp_str)
            else:
                pattern = re.compile(r'-')  # РАЗНЫЕ СИМВОЛЫ, НЕ ТРОГАТЬ!!!!!
                match = re.findall(pattern, temp_str)
                if match:
                    data_list = re.split(pattern, temp_str)
            new_data = [-1, -1, -1, -1]
            n = 0
            for k in data_list:
                k = k.replace(' ', '')
                if n > 3:
                    break
                if k.isdigit() == False:
                    matches = datefinder.find_dates(k)
                    for match in matches:
                        new_str = str(match)
                        new_str = re.split(' ', new_str)
                        new_str[0] = new_str[0].replace('-', '.')
                        temper_list = new_str[0].split('.')

                        new_str[0] = temper_list[2] + '.' + temper_list[1] + '.' + temper_list[0]
                        new_data[n] = new_str[0]
                if k.isdigit():
                    new_data[n] = k
                n += 2

            if str(new_data[0]).isdigit():
                if is_BC:
                    new_data[0] = '-1.01.' + new_data[0]
                else:
                    new_data[0] = '1.01.' + new_data[0]
                new_data[1] = '2'
            else:
                new_data[1] = '0'

            if new_data[2] == -1:
                new_data[2] = 'по наст. время'
                new_data[3] = '0'

            if new_data[2].isdigit():
                if is_BC:
                    new_data[2] = '-1.01.' + new_data[2]
                else:
                    new_data[2] = '1.01.' + new_data[2]
                new_data[3] = '2'  # СТАВИМ ПЕРВЫЙ УРОВЕНЬ
            else:
                new_data[3] = '0'

            for count in new_data:
                if count == -1 or (is_BC and count == 'по наст. время'):
                    new_data = None
            if new_data != None:
                temp = new_data
                new_data = []
                new_data.append(temp)
            else:
                return None
        return new_data
    except:
        None

url = get_wiki_url('Q378158')
ans = get_dates_from_url(url, 'Q378158', 'President of Ecuador')

print(ans)
